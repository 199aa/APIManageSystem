# 权限控制完善说明

## 🔒 问题描述

**原始问题**：系统中所有用户（超级管理员、管理员、运维人员、开发人员、访客、测试人员）的访问权限都一样，存在严重的安全隐患。

**影响**：
- 任何登录用户都能访问所有功能
- 无法实现职责分离和最小权限原则
- 存在数据泄露和误操作风险

---

## ✅ 解决方案

### 1. 后端权限控制

#### 新增权限拦截器
- **文件**：`PermissionInterceptor.java`
- **功能**：验证用户是否有访问接口的权限
- **机制**：
  - 超级管理员（roleId=1）拥有所有权限
  - 其他用户根据角色权限表验证访问权限
  - 无权限返回403错误

#### 更新WebConfig
- 添加权限拦截器到拦截器链
- 在JWT认证后执行权限验证

#### 更新登录接口
- 登录成功后返回用户权限列表
- 前端保存权限信息用于界面控制

---

### 2. 前端权限控制

#### 更新Vuex Store
- 保存用户权限列表
- 提供`hasPermission`方法用于权限判断

#### 更新路由守卫
- 检查路由所需权限
- 无权限自动跳转到首页

#### 为路由添加权限标识
- 每个路由配置`meta.permission`字段
- 标识访问该路由需要的权限

---

## 📋 各角色权限分配

### 1. 超级管理员 (roleId=1)
**权限**：所有权限（全部功能）

**职责**：
- 系统所有功能的完全控制权
- 用户和角色管理
- 系统配置和维护

---

### 2. 管理员 (roleId=2)
**权限**：
- ✅ 平台接入：查看、新增、编辑、删除
- ✅ API管理：查看、新增、编辑、删除、测试
- ✅ 客户应用：查看、新增、编辑、删除
- ✅ 系统管理：用户管理、角色管理、操作日志

**职责**：
- 日常业务管理
- 用户和权限管理
- 不包括编排和治理功能

---

### 3. 运维人员 (roleId=3)
**权限**：
- ✅ 平台接入：查看
- ✅ API管理：查看、测试
- ✅ 服务编排：查看、设计
- ✅ 治理中心：限流、黑白名单、缓存
- ✅ 监控中心：调用日志、告警管理

**职责**：
- 系统运维和监控
- 性能优化和故障处理
- 不能修改API和平台配置

---

### 4. 开发人员 (roleId=4)
**权限**：
- ✅ 平台接入：查看
- ✅ API管理：查看、测试
- ✅ 服务编排：查看
- ✅ 监控中心：调用日志

**职责**：
- API查询和测试
- 问题调试
- 不能修改任何配置

---

### 5. 访客 (roleId=5)
**权限**：
- ✅ 平台接入：查看
- ✅ API管理：查看

**职责**：
- 只读访问
- 查看API文档
- 无任何修改权限

---

### 6. 测试人员 (roleId=6)
**权限**：（需要在数据库中配置）
- ✅ 平台接入：查看
- ✅ API管理：查看、测试
- ✅ 监控中心：调用日志

**职责**：
- API测试
- 问题验证
- 日志查看

---

## 🔐 权限编码说明

**重要**：前端菜单和路由权限必须与数据库中的权限代码完全匹配！

| 模块 | 权限编码 | 说明 |
|------|---------|------|
| **平台接入** | | |
| 模块访问 | `platform` | 查看平台模块 |
| 查看列表 | `platform:list` | 查看平台列表 |
| 新增平台 | `platform:create` | 创建新平台 |
| 编辑平台 | `platform:update` | 修改平台信息 |
| 删除平台 | `platform:delete` | 删除平台 |
| **API管理** | | |
| 模块访问 | `api` | 查看API模块 |
| 查看列表 | `api:list` | 查看API列表 |
| 查看详情 | `api:detail` | 查看API详情 |
| 新增API | `api:create` | 创建新API |
| 编辑API | `api:update` | 修改API信息 |
| 删除API | `api:delete` | 删除API |
| 测试API | `api:test` | 测试API功能 |
| **客户应用** | | |
| 模块访问 | `customer` | 查看客户模块 |
| 查看列表 | `customer:list` | 查看应用列表 |
| 新增应用 | `customer:create` | 创建新应用 |
| 编辑应用 | `customer:update` | 修改应用信息 |
| 删除应用 | `customer:delete` | 删除应用 |
| **服务编排** | | |
| 模块访问 | `orchestration` | 查看编排模块 |
| 聚合接口 | `orchestration:aggregate` | 查看聚合接口列表 |
| 接口设计 | `orchestration:design` | 设计编排接口 |
| 创建编排 | `orchestration:create` | 创建编排 |
| 编辑编排 | `orchestration:update` | 修改编排 |
| 删除编排 | `orchestration:delete` | 删除编排 |
| **治理中心** | | |
| 模块访问 | `governance` | 查看治理模块 |
| 限流策略 | `governance:ratelimit` | 查看和配置限流 |
| 黑白名单 | `governance:blacklist` | 查看和配置黑白名单 |
| 缓存策略 | `governance:cache` | 查看和配置缓存 |
| **监控中心** | | |
| 模块访问 | `monitor` | 查看监控模块 |
| 调用日志 | `monitor:logs` | 查看调用日志 |
| 告警管理 | `monitor:alerts` | 管理告警 |
| **系统管理** | | |
| 用户列表 | `system:user:list` | 查看用户 |
| 创建用户 | `system:user:create` | 创建用户 |
| 编辑用户 | `system:user:update` | 修改用户 |
| 删除用户 | `system:user:delete` | 删除用户 |
| 角色列表 | `system:role:list` | 查看角色 |
| 创建角色 | `system:role:create` | 创建角色 |
| 编辑角色 | `system:role:update` | 修改角色 |
| 删除角色 | `system:role:delete` | 删除角色 |
| 操作日志 | `system:log:list` | 查看操作日志 |

---

## 🎯 测试方法

### 1. 测试不同角色登录
```bash
# 超级管理员
用户名：admin / 密码：admin123

# 管理员
用户名：manager / 密码：manager123

# 运维人员
用户名：ops / 密码：ops123

# 开发人员
用户名：dev / 密码：dev123

# 访客
用户名：guest / 密码：guest123
```

### 2. 验证权限控制
- 使用不同角色登录
- 尝试访问各个菜单和功能
- 无权限的页面应该无法访问（自动跳转到首页）
- 无权限的操作按钮应该隐藏或禁用

### 3. 验证后端拦截
- 使用Postman等工具直接调用API
- 携带不同角色的token
- 验证后端返回403错误

---

## 📝 使用说明

### 前端权限判断
```javascript
// 在组件中判断权限
computed: {
  canCreate() {
    return this.$store.getters['user/hasPermission']('api:create')
  }
}

// 在模板中使用
<el-button v-if="$store.getters['user/hasPermission']('api:create')">新建</el-button>
```

### 修改角色权限
1. 进入"系统管理" → "角色管理"
2. 点击角色的"权限"按钮
3. 勾选/取消权限
4. 保存
5. 用户需要重新登录生效

---

## ⚠️ 注意事项

1. **超级管理员不可删除**：系统至少保留一个超级管理员
2. **权限立即生效**：修改权限后，用户需要重新登录
3. **前后端双重验证**：前端控制界面，后端控制数据
4. **最小权限原则**：给用户分配完成工作所需的最小权限集合

---

## 🔄 后续优化建议

1. **动态菜单**：根据用户权限动态生成菜单
2. **按钮级权限**：更细粒度的按钮权限控制
3. **数据权限**：同一功能不同用户看到不同数据
4. **权限缓存**：使用Redis缓存权限信息提高性能
5. **审计日志**：记录所有权限变更操作

---

## 📚 相关文件

### 后端
- `PermissionInterceptor.java` - 权限拦截器
- `WebConfig.java` - Web配置
- `UserController.java` - 用户控制器（登录返回权限）

### 前端
- `store/modules/user.js` - 用户状态管理
- `router/index.js` - 路由配置和守卫
- `views/login/index.vue` - 登录页面

### 数据库
- `permission.sql` - 权限数据和角色权限关联

---

**更新时间**：2026-01-04
**版本**：v1.0
