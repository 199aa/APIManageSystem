<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.api.mapper.OperationLogMapper">
  
  <resultMap id="BaseResultMap" type="com.api.model.OperationLog">
    <id column="id" property="id" />
    <result column="user_id" property="userId" />
    <result column="username" property="username" />
    <result column="oper_type" property="operType" />
    <result column="module" property="module" />
    <result column="description" property="description" />
    <result column="request_method" property="requestMethod" />
    <result column="request_url" property="requestUrl" />
    <result column="request_params" property="requestParams" />
    <result column="response_result" property="responseResult" />
    <result column="ip" property="ip" />
    <result column="browser" property="browser" />
    <result column="status" property="status" />
    <result column="error_msg" property="errorMsg" />
    <result column="cost_time" property="costTime" />
    <result column="oper_time" property="operTime" />
  </resultMap>
  
  <sql id="Base_Column_List">
    id, user_id, username, oper_type, module, description, 
    request_method, request_url, request_params, response_result,
    ip, browser, status, error_msg, cost_time, oper_time
  </sql>
  
  <insert id="insert" parameterType="com.api.model.OperationLog" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO operation_log (
      user_id, username, oper_type, module, description,
      request_method, request_url, request_params, response_result,
      ip, browser, status, error_msg, cost_time
    ) VALUES (
      #{userId}, #{username}, #{operType}, #{module}, #{description},
      #{requestMethod}, #{requestUrl}, #{requestParams}, #{responseResult},
      #{ip}, #{browser}, #{status}, #{errorMsg}, #{costTime}
    )
  </insert>
  
  <select id="selectById" resultMap="BaseResultMap">
    SELECT <include refid="Base_Column_List" />
    FROM operation_log
    WHERE id = #{id}
  </select>
  
  <select id="selectByPage" resultMap="BaseResultMap">
    SELECT <include refid="Base_Column_List" />
    FROM operation_log
    <where>
      <if test="params.username != null and params.username != ''">
        AND username LIKE CONCAT('%', #{params.username}, '%')
      </if>
      <if test="params.operType != null and params.operType != ''">
        AND oper_type = #{params.operType}
      </if>
      <if test="params.module != null and params.module != ''">
        AND module = #{params.module}
      </if>
      <if test="params.status != null">
        AND status = #{params.status}
      </if>
      <if test="params.startDate != null">
        AND oper_time &gt;= #{params.startDate}
      </if>
      <if test="params.endDate != null">
        AND oper_time &lt;= #{params.endDate}
      </if>
    </where>
    ORDER BY oper_time DESC
    LIMIT #{params.offset}, #{params.limit}
  </select>
  
  <select id="selectAll" resultMap="BaseResultMap">
    SELECT <include refid="Base_Column_List" />
    FROM operation_log
    <where>
      <if test="params.username != null and params.username != ''">
        AND username LIKE CONCAT('%', #{params.username}, '%')
      </if>
      <if test="params.operType != null and params.operType != ''">
        AND oper_type = #{params.operType}
      </if>
      <if test="params.module != null and params.module != ''">
        AND module = #{params.module}
      </if>
      <if test="params.status != null">
        AND status = #{params.status}
      </if>
      <if test="params.startDate != null">
        AND oper_time &gt;= #{params.startDate}
      </if>
      <if test="params.endDate != null">
        AND oper_time &lt;= #{params.endDate}
      </if>
    </where>
    ORDER BY oper_time DESC
  </select>
  
  <select id="countByCondition" resultType="int">
    SELECT COUNT(*)
    FROM operation_log
    <where>
      <if test="params.username != null and params.username != ''">
        AND username LIKE CONCAT('%', #{params.username}, '%')
      </if>
      <if test="params.operType != null and params.operType != ''">
        AND oper_type = #{params.operType}
      </if>
      <if test="params.module != null and params.module != ''">
        AND module = #{params.module}
      </if>
      <if test="params.status != null">
        AND status = #{params.status}
      </if>
      <if test="params.startDate != null">
        AND oper_time &gt;= #{params.startDate}
      </if>
      <if test="params.endDate != null">
        AND oper_time &lt;= #{params.endDate}
      </if>
    </where>
  </select>
  
  <delete id="deleteBatch">
    DELETE FROM operation_log WHERE id IN
    <foreach collection="ids" item="id" open="(" separator="," close=")">
      #{id}
    </foreach>
  </delete>
  
  <delete id="deleteBeforeDate">
    DELETE FROM operation_log WHERE oper_time &lt; #{date}
  </delete>
  
</mapper>
